#!/bin/bash
select_from() {
  local c
  for c; do
    if command -v "${c%% *}" &> /dev/null; then
      echo "$c"
      return 0
    fi
  done
  return 1
}

select_editor() {
    [ -z "$EDITOR" ] && EDITOR=vim
    [[ "$EDITOR" =~ ^.*vi.*$ ]] &&  EDITOR_EXTRARG='+{2}' # for linenumber
}


preview=$(select_from 'bat --color=always --style=header,numbers -H {2} {1}' \
    'awk "BEGIN{a=\"'"{2}"'\";gsub(\"'"'"'\", \"\", a)} NR==(a+0){print \"\033[1;31m\" \$0 \"\033[0m\"; next} {print}" {1}' \
    'cat {1}')

    # 'awk "'"BEGIN{a=\\\"{2}\\\";gsub(\\\"'\\\", \\\"\\\", a)}"' NR==(a+0){print \"\033[1;31m\" \$0 \"\033[0m\"; next} {print}" {1}' \
select_editor

command=$(select_from 'rg -n --color=always' 'grep -Rn --color=always')
echo "$preview"

fzf -d: \
--ansi \
--query="$1" \
--phony \
--bind="change:reload:$command {q}" \
--bind="start:reload:$command {q}" \
--bind="enter:execute:$EDITOR {1} $EDITOR_EXTRARG" \
--preview-window='+{2}-/2' \
--preview="[[ -n {1} ]] && $preview"
